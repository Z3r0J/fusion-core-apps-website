---
import PlaceholderApp from "@/assets/placeholder-app.svg";
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import { ArrowRight, Star } from "lucide-react";
const { app, featured = false } = Astro.props as {
	app: CollectionEntry<"apps">;
	featured?: boolean;
};

// Extract rating and downloads from app data, fallback to defaults if not available
const rating = app.data.rating ?? 4.5;
const downloads = app.data.downloads ?? "1K+";
const price = app.data.price || "Free";

// Generate a unique ID for this card's modal
const modalId = `download-modal-${app.slug}`;
---

<article
	class:list={[
		`app-card card card--elevated group transition-all duration-300 hover:scale-105`,
		{ "app-card--featured": featured },
	]}
>
	<a aria-label={`${app.data.title} app`} class="app-card__link block" href={`/apps/${app.slug}`}>
		<!-- App Icon & Badge -->
		<div class="app-card__header relative p-6 pb-4">
			<div class="flex items-start gap-4">
				<!-- App Icon -->
				<div class="app-card__icon-wrapper relative flex-shrink-0">
					{
						app.data.icon ? (
							<Image
								alt={`${app.data.title} app icon`}
								class="app-card__icon h-16 w-16 rounded-2xl shadow-lg transition-shadow duration-300 group-hover:shadow-xl"
								height={64}
								loading="lazy"
								src={app.data.icon}
								width={64}
							/>
						) : (
							<PlaceholderApp class="app-card__icon h-16 w-16 rounded-2xl shadow-lg transition-shadow duration-300 group-hover:shadow-xl" />
						)
					}

					{
						featured && (
							<div class="absolute -top-2 -right-2 flex h-6 w-6 items-center justify-center rounded-full bg-gradient-to-br from-yellow-400 to-yellow-500 shadow-lg">
								<Star className="h-3 w-3 text-white" fill="currentColor" />
							</div>
						)
					}
				</div>

				<!-- App Info -->
				<div class="app-card__info min-w-0 flex-1">
					<h3
						class="app-card__title group-hover:text-brand-600 dark:group-hover:text-brand-400 truncate text-lg font-bold text-gray-900 transition-colors duration-200 dark:text-white"
					>
						{app.data.title}
					</h3>
					<p class="app-card__tagline mt-1 line-clamp-2 text-sm text-gray-600 dark:text-gray-400">
						{app.data.tagline}
					</p>

					<!-- Rating & Downloads -->
					<div class="app-card__meta mt-3 flex items-center gap-4">
						<div class="flex items-center gap-1">
							<div class="flex items-center">
								{
									Array.from({ length: 5 }).map((_, i) => (
										<Star
											className={`h-3 w-3 ${i < Math.floor(rating) ? "text-yellow-400" : "text-gray-300 dark:text-gray-600"}`}
											fill="currentColor"
										/>
									))
								}
							</div>
							<span class="ml-1 text-xs text-gray-500 dark:text-gray-400">{rating}</span>
						</div>

						<div class="text-xs text-gray-500 dark:text-gray-400">
							{downloads}
						</div>
					</div>
				</div>

				<!-- Price Badge -->
				<div class="app-card__price">
					<span
						class:list={[
							`inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium`,
							{
								"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400":
									price === "Free",
								"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400":
									price !== "Free",
							},
						]}
					>
						{price}
					</span>
				</div>
			</div>
		</div>

		<!-- App Description -->
		<div class="app-card__body px-6 pb-4">
			<p
				class="app-card__description line-clamp-3 text-sm leading-relaxed text-gray-700 dark:text-gray-300"
			>
				{app.data.description}
			</p>
		</div>

		<!-- App Footer -->
		<div class="app-card__footer px-6 pb-6">
			<div class="flex items-center justify-between">
				<!-- Category -->
				<span
					class="app-card__category inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-xs font-medium text-gray-700 dark:bg-gray-800 dark:text-gray-300"
				>
					{app.data.category}
				</span>
			</div>
		</div>
	</a>

	<!-- Download CTA (outside the link) -->
	<div class="app-card__footer-cta -mt-6 px-6 pb-6">
		<div class="flex items-center justify-end">
			<button
				type="button"
				data-modal-id={modalId}
				class="download-btn text-brand-600 dark:text-brand-400 hover:text-brand-700 dark:hover:text-brand-300 flex items-center text-sm font-medium transition-colors"
			>
				<span>Download</span>
				<ArrowRight className="ml-1 h-4 w-4 transition-transform group-hover:translate-x-1" />
			</button>
		</div>
	</div>
</article>

<!-- Download Modal -->
<div
	id={modalId}
	class="download-modal fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm"
	aria-hidden="true"
>
	<div
		class="modal-content relative m-4 max-w-md rounded-2xl bg-white p-6 shadow-2xl dark:bg-gray-800"
		role="dialog"
		aria-modal="true"
		aria-labelledby={`${modalId}-title`}
	>
		<!-- Close Button -->
		<button
			type="button"
			class="close-modal absolute top-4 right-4 text-gray-400 transition-colors hover:text-gray-600 dark:hover:text-gray-200"
			aria-label="Close"
		>
			<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path
					stroke-linecap="round"
					stroke-linejoin="round"
					stroke-width="2"
					d="M6 18L18 6M6 6l12 12"></path>
			</svg>
		</button>

		<!-- Modal Header -->
		<div class="mb-6">
			<div class="mb-4 flex items-center gap-3">
				{
					app.data.icon ? (
						<Image
							alt={`${app.data.title} app icon`}
							class="h-12 w-12 rounded-xl"
							height={48}
							loading="lazy"
							src={app.data.icon}
							width={48}
						/>
					) : (
						<PlaceholderApp class="h-12 w-12 rounded-xl" />
					)
				}
				<div>
					<h3 id={`${modalId}-title`} class="text-xl font-bold text-gray-900 dark:text-white">
						{app.data.title}
					</h3>
				</div>
			</div>
			<p class="text-sm text-gray-600 dark:text-gray-400">Choose your platform to download</p>
		</div>

		<!-- Download Options -->
		<div class="space-y-3">
			<!-- Google Play Button -->
			<a
				href={app.data.playUrl}
				target="_blank"
				rel="noopener noreferrer"
				class="hover:border-brand-500 dark:hover:border-brand-400 flex items-center gap-4 rounded-xl border-2 border-gray-200 bg-white p-4 transition-all hover:shadow-md dark:border-gray-700 dark:bg-gray-900"
			>
				<div class="flex-shrink-0">
					<svg class="h-10 w-10" viewBox="0 0 24 24" fill="none">
						<path
							d="M3 20.5V3.5C3 2.91 3.34 2.39 3.84 2.15L13.69 12L3.84 21.85C3.34 21.6 3 21.09 3 20.5Z"
							fill="#00D6FF"></path>
						<path d="M16.81 15.12L6.05 21.34L14.54 12.85L16.81 15.12Z" fill="#FFC107"></path>
						<path
							d="M20.16 10.81C20.5 11.08 20.75 11.5 20.75 12C20.75 12.5 20.53 12.9 20.18 13.18L17.89 14.5L15.39 12L17.89 9.5L20.16 10.81Z"
							fill="#FF3E00"></path>
						<path d="M6.05 2.66L16.81 8.88L14.54 11.15L6.05 2.66Z" fill="#00E081"></path>
					</svg>
				</div>
				<div class="flex-1 text-left">
					<div class="text-sm font-semibold text-gray-900 dark:text-white">Google Play</div>
					<div class="text-xs text-gray-500 dark:text-gray-400">Download for Android</div>
				</div>
				<ArrowRight className="h-5 w-5 text-gray-400" />
			</a>

			<!-- App Store Button -->
			{
				app.data.appStoreUrl && (
					<a
						href={app.data.appStoreUrl}
						target="_blank"
						rel="noopener noreferrer"
						class="hover:border-brand-500 dark:hover:border-brand-400 flex items-center gap-4 rounded-xl border-2 border-gray-200 bg-white p-4 transition-all hover:shadow-md dark:border-gray-700 dark:bg-gray-900"
					>
						<div class="flex-shrink-0">
							<svg class="h-10 w-10" viewBox="0 0 24 24" fill="currentColor">
								<path
									d="M18.71 19.5C17.88 20.74 17 21.95 15.66 21.97C14.32 22 13.89 21.18 12.37 21.18C10.84 21.18 10.37 21.95 9.1 22C7.79 22.05 6.8 20.68 5.96 19.47C4.25 17 2.94 12.45 4.7 9.39C5.57 7.87 7.13 6.91 8.82 6.88C10.1 6.86 11.32 7.75 12.11 7.75C12.89 7.75 14.37 6.68 15.92 6.84C16.57 6.87 18.39 7.1 19.56 8.82C19.47 8.88 17.39 10.1 17.41 12.63C17.44 15.65 20.06 16.66 20.09 16.67C20.06 16.74 19.67 18.11 18.71 19.5ZM13 3.5C13.73 2.67 14.94 2.04 15.94 2C16.07 3.17 15.6 4.35 14.9 5.19C14.21 6.04 13.07 6.7 11.95 6.61C11.8 5.46 12.36 4.26 13 3.5Z"
									class="text-gray-900 dark:text-white"
								/>
							</svg>
						</div>
						<div class="flex-1 text-left">
							<div class="text-sm font-semibold text-gray-900 dark:text-white">App Store</div>
							<div class="text-xs text-gray-500 dark:text-gray-400">Download for iOS</div>
						</div>
						<ArrowRight className="h-5 w-5 text-gray-400" />
					</a>
				)
			}
		</div>
	</div>
</div>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>

<script>
	// Handle modal opening and closing
	document.addEventListener("DOMContentLoaded", () => {
		// Open modal
		document.querySelectorAll(".download-btn").forEach((btn) => {
			btn.addEventListener("click", (e) => {
				e.preventDefault();
				e.stopPropagation();
				const modalId = (e.currentTarget as HTMLElement).dataset.modalId;
				const modal = document.getElementById(modalId as string);
				if (modal) {
					modal.classList.remove("hidden");
					modal.classList.add("flex");
					modal.setAttribute("aria-hidden", "false");
					document.body.style.overflow = "hidden";
				}
			});
		});

		// Close modal
		const closeModal = (modal: HTMLElement) => {
			modal.classList.add("hidden");
			modal.classList.remove("flex");
			modal.setAttribute("aria-hidden", "true");
			document.body.style.overflow = "";
		};

		// Close button
		document.querySelectorAll(".close-modal").forEach((btn) => {
			btn.addEventListener("click", (e) => {
				const modal = (e.target as HTMLElement).closest(".download-modal");
				if (modal) closeModal(modal as HTMLElement);
			});
		});

		// Close on backdrop click
		document.querySelectorAll(".download-modal").forEach((modal) => {
			modal.addEventListener("click", (e) => {
				if (e.target === modal) {
					closeModal(modal as HTMLElement);
				}
			});
		});

		// Close on Escape key
		document.addEventListener("keydown", (e) => {
			if (e.key === "Escape") {
				document.querySelectorAll(".download-modal").forEach((modal) => {
					if (!modal.classList.contains("hidden")) {
						closeModal(modal as HTMLElement);
					}
				});
			}
		});
	});
</script>
